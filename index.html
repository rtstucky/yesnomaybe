<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wichita Zoning Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div id="container">
        <div id="map"></div>
        
        <div id="sidebar">
            <div id="sidebar-header">
                <h1>Can you build here?</h1>
                <p>Loading map data...</p>
            </div>
            <div id="sidebar-content">
                <div class="detail-row">
                    <div class="detail-label">Select Land Use</div>
                    <select id="use-select">
                        <option value="">Choose a use...</option>
                    </select>
                </div>
                
                <div id="legend" style="margin-top: 20px; display: none;">
                    <div class="detail-label">Legend</div>
                    <div style="margin-top: 10px;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <div style="width: 20px; height: 20px; background: #4CAF50; margin-right: 10px; border: 1px solid #333;"></div>
                            <span>Yes</span>
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <div style="width: 20px; height: 20px; background: #7570b3; margin-right: 10px; border: 1px solid #333;"></div>
                            <span>No</span>
                        </div>
                          <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <div style="width: 20px; height: 20px; background: #d95f02; margin-right: 10px; border: 1px solid #333;"></div>
                            <span>Maybe</span>
                        </div>
                    </div>
                </div>
                
                <div id="chart-container" style="margin-top: 20px; display: none;">
                    <div class="detail-label">Area by Permission Type</div>
                    <div style="margin-top: 10px; position: relative; height: 250px;">
                        <canvas id="areaChart"></canvas>
                    </div>
                    <div id="area-stats" style="margin-top: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let zoningLayer;
        let zoneData = {}; // Store the CSV data: { 'Land Use Name': { 'RR': 'P', 'SF-20': 'N', ... } }
        let zoneHeaders = []; // Store zone column headers
        let areaChart = null; // Chart.js instance
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([37.6872, -97.3301], 11);
            
            // Add Stadia Maps tiles
            L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_toner/{z}/{x}/{y}{r}.png?api_key=4f4c222f-cf1d-412d-a93a-e8bdaf1e4a3d', {
                maxZoom: 20,
                attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>, &copy; <a href="https://stamen.com/">Stamen Design</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);        
        }
        
        // Get area from the API's Shape.STArea() field (already in square feet)
        function calculateArea(geometry, properties) {
            // Use the Shape.STArea() field if available, otherwise return 0
            return properties['Shape.STArea()'] || 0;
        }
        
        // Load GeoJSON data from ArcGIS with pagination, filtered by Wichita city boundary
        async function loadZoningData() {
            try {
                // First, load the Wichita city boundary
                document.querySelector('#sidebar-header p').textContent = 'Loading city boundary...';
                
                const cityUrl = 'https://gismaps.wichita.gov/ageweb/rest/services/COWGIS/Districts/MapServer/2/query?where=CITY%3D%27WICHITA%27&outFields=*&outSR=4326&f=geojson';
                const cityResponse = await fetch(cityUrl);
                const cityData = await cityResponse.json();
                
                if (!cityData.features || cityData.features.length === 0) {
                    throw new Error('Could not load Wichita city boundary');
                }
                
                const wichitaBoundary = cityData.features[0].geometry;
                console.log('Wichita boundary loaded');
                
                // Now load zoning data with pagination
                let allFeatures = [];
                let offset = 0;
                const limit = 1000;
                let hasMore = true;
                
                document.querySelector('#sidebar-header p').textContent = 'Loading zoning data...';
                
                while (hasMore) {
                    const url = `https://gismaps.wichita.gov/ageweb/rest/services/COWGIS/Plan_Zoning/MapServer/7/query?where=1%3D1&outFields=*&outSR=4326&f=geojson&resultOffset=${offset}&resultRecordCount=${limit}`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.features && data.features.length > 0) {
                        // Filter features to only include those within Wichita
                        const filteredFeatures = data.features.filter(feature => {
                            return isWithinBoundary(feature.geometry, wichitaBoundary);
                        });
                        
                        allFeatures = allFeatures.concat(filteredFeatures);
                        offset += data.features.length;
                        document.querySelector('#sidebar-header p').textContent = `Loading... ${allFeatures.length} zones in Wichita`;
                        
                        if (data.features.length < limit) {
                            hasMore = false;
                        }
                    } else {
                        hasMore = false;
                    }
                }
                
                console.log('Total features in Wichita:', allFeatures.length);
                
                const geojson = {
                    type: 'FeatureCollection',
                    features: allFeatures
                };
                
                zoningLayer = L.geoJSON(geojson, {
                    style: {
                        fillColor: '#666',
                        fillOpacity: 0.4,
                        color: '#999',
                        weight: 1
                    },
                    onEachFeature: (feature, layer) => {
                        const zone = feature.properties.ZONING;
                        
                        // Get area from Shape.STArea() field
                        feature.properties.calculatedArea = calculateArea(feature.geometry, feature.properties);
                        
                        layer.on('click', function() {
                            layer.bindPopup(`<strong>Zoning:</strong> ${zone}`).openPopup();
                        });
                    }
                }).addTo(map);
                
                map.fitBounds(zoningLayer.getBounds());
                
                document.querySelector('#sidebar-header p').textContent = `${allFeatures.length} zones loaded`;
            } catch (error) {
                console.error('Error loading zoning data:', error);
                document.querySelector('#sidebar-header p').textContent = 'Error loading map';
            }
        }
        
        // Check if a geometry is within a boundary using a simple point-in-polygon test
        function isWithinBoundary(geometry, boundary) {
            // Get a representative point from the geometry (centroid approximation)
            let testPoint;
            
            if (geometry.type === 'Polygon') {
                const coords = geometry.coordinates[0];
                testPoint = getCentroid(coords);
            } else if (geometry.type === 'MultiPolygon') {
                const coords = geometry.coordinates[0][0];
                testPoint = getCentroid(coords);
            } else {
                return false;
            }
            
            // Check if point is within boundary
            if (boundary.type === 'Polygon') {
                return pointInPolygon(testPoint, boundary.coordinates[0]);
            } else if (boundary.type === 'MultiPolygon') {
                return boundary.coordinates.some(poly => pointInPolygon(testPoint, poly[0]));
            }
            
            return false;
        }
        
        // Calculate centroid of a polygon ring
        function getCentroid(ring) {
            let x = 0, y = 0;
            for (const coord of ring) {
                x += coord[0];
                y += coord[1];
            }
            return [x / ring.length, y / ring.length];
        }
        
        // Point-in-polygon ray casting algorithm
        function pointInPolygon(point, polygon) {
            const x = point[0], y = point[1];
            let inside = false;
            
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i][0], yi = polygon[i][1];
                const xj = polygon[j][0], yj = polygon[j][1];
                
                const intersect = ((yi > y) !== (yj > y)) && 
                    (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            
            return inside;
        }
        
        // Load CSV and populate dropdown
        async function loadCSV() {
            try {
                const response = await fetch('Zoning Use Regulations.csv');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                
                // Check if we accidentally got HTML instead of CSV
                if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
                    console.error('ERROR: Received HTML instead of CSV. Check that Zoning_Use_Regulations.csv exists in the correct location.');
                    alert('Error: CSV file not found. Please ensure Zoning_Use_Regulations.csv is in the same directory as this HTML file.');
                    return;
                }
                
                const lines = text.trim().split('\n');
                
                // Parse header row to get zone names
                const headerLine = lines[0];
                const headerParts = headerLine.split(',');
                zoneHeaders = headerParts.slice(1).map(h => h.trim()); // Skip first column, get zone names
                
                console.log('Zone headers:', zoneHeaders);
                
                const select = document.getElementById('use-select');
                
                // Parse each land use row
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // Parse CSV properly - handle quoted fields
                    let useName = '';
                    let values = [];
                    
                    if (line.startsWith('"')) {
                        // Field is quoted, find the closing quote
                        const closingQuoteIndex = line.indexOf('"', 1);
                        useName = line.substring(1, closingQuoteIndex);
                        // Get the rest of the line after the closing quote and comma
                        const remainingLine = line.substring(closingQuoteIndex + 2);
                        values = remainingLine.split(',').map(v => v.trim());
                    } else {
                        // Field is not quoted, split normally
                        const parts = line.split(',');
                        useName = parts[0].trim();
                        values = parts.slice(1).map(v => v.trim());
                    }
                    
                    if (useName && useName !== '') {
                        // Store the data for this land use
                        zoneData[useName] = {};
                        for (let j = 0; j < zoneHeaders.length; j++) {
                            zoneData[useName][zoneHeaders[j]] = values[j] || 'N';
                        }
                        
                        // Add to dropdown
                        const option = document.createElement('option');
                        option.value = useName;
                        option.textContent = useName;
                        select.appendChild(option);
                    }
                }
                
                console.log(`Successfully loaded ${select.options.length - 1} land uses`);
                console.log('Sample data:', zoneData['Single Family']);
            } catch (error) {
                console.error('Error loading CSV:', error);
                alert('Error loading CSV file: ' + error.message);
            }
        }
        
        // Update map colors based on selected land use
        function updateMapForLandUse(landUse) {
            const legend = document.getElementById('legend');
            const chartContainer = document.getElementById('chart-container');
            
            if (!landUse || !zoneData[landUse]) {
                // Reset to default styling
                zoningLayer.eachLayer(layer => {
                    layer.setStyle({
                        fillColor: '#666',
                        fillOpacity: 0.4,
                        color: '#999',
                        weight: 1
                    });
                });
                legend.style.display = 'none';
                chartContainer.style.display = 'none';
                return;
            }
            
            // Show legend and chart
            legend.style.display = 'block';
            chartContainer.style.display = 'block';
            
            // Color scheme for different permissions
            const colors = {
                'P': '#4CAF50',   // Green - Permitted
                'C': '#d95f02',   // Orange - Conditional (combines C and C/P)
                'N': '#7570b3'    // Purple - Not permitted
            };
            
            const useData = zoneData[landUse];
            
            // Track total areas by permission type
            const areaTotals = {
                'P': 0,
                'C': 0,
                'N': 0
            };
            
            zoningLayer.eachLayer(layer => {
                const zoning = layer.feature.properties.ZONING;
                let permission = useData[zoning] || 'N';
                const area = layer.feature.properties.calculatedArea || 0;
                
                // Normalize C/P to C
                if (permission === 'C/P') {
                    permission = 'C';
                }
                
                // Add to totals
                areaTotals[permission] = (areaTotals[permission] || 0) + area;
                
                layer.setStyle({
                    fillColor: colors[permission] || colors['N'],
                    fillOpacity: 0.6,
                    color: '#333',
                    weight: 1
                });
                
                // Update popup to show permission
                const displayPermission = useData[zoning] || 'N';
                layer.bindPopup(`<strong>Zoning:</strong> ${zoning}<br><strong>${landUse}:</strong> ${displayPermission}`);
            });
            
            // Update the chart
            updateAreaChart(areaTotals);
        }
        
        // Update or create the pie chart
        function updateAreaChart(areaTotals) {
            const ctx = document.getElementById('areaChart').getContext('2d');
            
            // Convert square feet to square miles and square kilometers
            const sqFeetToSqMiles = 1 / 27878400;
            const sqFeetToSqKm = 0.0000000929030;
            
            const totalArea = Object.values(areaTotals).reduce((sum, val) => sum + val, 0);
            
            // Prepare data
            const chartData = {
                labels: ['Permitted (P)', 'Conditional (C/C/P)', 'Not Permitted (N)'],
                datasets: [{
                    data: [
                        areaTotals['P'],
                        areaTotals['C'],
                        areaTotals['N']
                    ],
                    backgroundColor: ['#4CAF50', '#d95f02', '#7570b3'],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            };
            
            // Destroy existing chart if it exists
            if (areaChart) {
                areaChart.destroy();
            }
            
            // Create new chart
            areaChart = new Chart(ctx, {
                type: 'pie',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    events: []
                }
            });
            
            // Update stats text
            const statsDiv = document.getElementById('area-stats');
            const totalSqMiles = (totalArea * sqFeetToSqMiles).toFixed(2);
            const totalSqKm = (totalArea * sqFeetToSqKm).toFixed(2);
            
            statsDiv.innerHTML = `
                <strong>Total Area:</strong> ${totalSqMiles} square miles<br>
                <strong>Yes:</strong> ${((areaTotals['P'] / totalArea) * 100).toFixed(1)}% (${(areaTotals['P'] * sqFeetToSqMiles).toFixed(2)} mi²)<br>
                <strong>No:</strong> ${((areaTotals['N'] / totalArea) * 100).toFixed(1)}% (${(areaTotals['N'] * sqFeetToSqMiles).toFixed(2)} mi²)<br>
                <strong>Maybe:</strong> ${((areaTotals['C'] / totalArea) * 100).toFixed(1)}% (${(areaTotals['C'] * sqFeetToSqMiles).toFixed(2)} mi²)<br>
            `;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadCSV();
            loadZoningData();
            
            // Add event listener to dropdown
            document.getElementById('use-select').addEventListener('change', (e) => {
                updateMapForLandUse(e.target.value);
            });
        });
    </script>
</body>
</html>